---
title: "Analysis by age group"
author: "Jianyou Liu"
date: "November 30, 2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = FALSE)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_bw() + theme(legend.position = "bottom"))


```

#### Depression prevalence and Suicide death rate by **Age** in isolation to time(year) Analysis
##### Age intervals: "<25", "25-44","45-64", and "65+"

To investigate the relationship between depression rate and suicide death rate under age groups, we took the following steps:

*   For depression rate, we used the 'brfss' dataset and filtered out the responses that represent 'yes' for experiencing depression. Then, we computed the total sample size of the amount of people who answered the question on the survey and combined the age groups into one of the 4 categories mentioned above. Next, we grouped by the final age groups and obtained summation of the total number of partipants who reported depression over each age category along with the total number of responses and conducted a proportion test to get the estimated proportion of depression among each age group as well as their confidence intervals. Finally, we generated a plot to visually represent the results,

* For suicide death rate, we used the 'injury' dataset and did similar data processing procedures and exploratory analysis as we did for the 'brfss' dataset. The suicide death rate is computed by dividing the total number of deaths from suicide attempts by the total population.

```{r read_data, message = FALSE}
brfss_data = read_csv("./data/brfss_data.csv") %>% 
  janitor::clean_names()
View(brfss_data)
```

```{r modify_data}
new_brfss_data = brfss_data %>% 
  filter(break_out_category_id == "CAT3") %>% 
  select(year, locationabbr, locationdesc, age_group, topic, response, sample_size, data_value, confidence_limit_low, confidence_limit_high) %>% 
  unite(locationabbr, locationdesc, col = "state_city", sep = ",")

age_data = new_brfss_data %>% 
  filter(response == "Yes") %>% 
  mutate(tot_sample_size = ceiling(sample_size/(data_value/100))) %>% 
  mutate(age_group = str_replace(age_group, "25-34", "25-44"), age_group = str_replace(age_group, "35-44", "25-44"), age_group = str_replace(age_group, "45-54", "45-64"),age_group = str_replace(age_group, "55-64", "45-64")，age_group = str_replace(age_group, "18-24", "<25")) %>% 
  select(year, state_city, age_group, sample_size, tot_sample_size, data_value, confidence_limit_low, confidence_limit_high) %>% 
  rename(depress_num = sample_size, depress_rate = data_value) %>% 
  group_by(age_group) %>%
  summarize(total_dep = sum(depress_num, na.rm = TRUE), total_num = sum(tot_sample_size, na.rm = TRUE))
  
```

```{r prop_test}
# Run prop.test for each age group
test_data = age_data %>% 
  mutate(test_stats = map2(.x = total_dep, .y = total_num, ~ prop.test(x = .x, n = .y, conf.level = .95) %>% broom::tidy())) %>% 
  unnest() %>% 
  select(age_group, total_dep, total_num, estimate, conf.low, conf.high)
```

```{r plot}
test_data %>% 
  mutate(age_group = fct_reorder(age_group, estimate)) %>% 
  ggplot(aes(x = age_group, y = estimate, color = age_group)) +
  geom_bar(stat = "identity", position = position_dodge(), width = .6) +
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high), width = .2) + 
  theme(plot.title = element_text(hjust = .5)) +
  labs(
    title = "Estimates of Proportion of Depression and CIs \n for each Age Category",
    x = "Age Group",
    y = "Estimated Depression Rate"
  ) +
  viridis::scale_color_viridis(
    name = "Age Group",
    discrete = TRUE
  )
  
```

```{r import_data, message = FALSE}
injury_data = read_csv("./data/NCHS_-_Injury_Mortality__United_States.csv") %>% 
  janitor::clean_names()
```

```{r tidy_data}
new_injury_data = injury_data %>% 
  select(year, age_group_years, injury_intent, deaths, population) %>% 
  distinct(year, age_group_years, injury_intent, .keep_all = TRUE) %>% 
  filter(injury_intent == "Suicide", age_group_years != "All Ages", year %in% c(2011, 2012, 2013, 2014, 2015, 2016)) %>% 
  arrange(year) %>% 
  mutate(age_group_years = str_replace(age_group_years, "15–24","<25"),age_group_years = str_replace(age_group_years, "< 15","<25"
), age_group_years = str_replace(age_group_years, "65–74","65+"), age_group_years = str_replace(age_group_years, "75+","65")) %>% 
  group_by(age_group_years) %>% 
  summarize(tot_suicide_deaths = sum(deaths), tot_pop = sum(population))
  
```

```{r prop_test2}
test_data2 = new_injury_data %>% 
  mutate(test_stats = map2(.x = tot_suicide_deaths, .y = tot_pop, ~ prop.test(x = .x, n = .y, conf.level = .95) %>% broom::tidy())) %>% 
  unnest() %>% 
  select(age_group_years, tot_suicide_deaths, tot_pop, estimate, conf.low, conf.high) %>% 
  mutate(estimate = estimate*100000, conf.low = conf.low*100000, conf.high = conf.high*100000)

```

```{r plot2}
 test_data2 %>% 
  mutate(age_group_years = fct_reorder(age_group_years, estimate)) %>% 
  ggplot(aes(x = age_group_years, y = estimate, color = age_group_years)) +
  geom_bar(stat = "identity", position = position_dodge(), width = .6) +
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high), width = .2) +
  theme(plot.title = element_text(hjust = .5)) +
  labs(
    title = "Estimated suicide death rate(per 100,000 population) and CIs for \n each Age Category",
    x = "Age Group",
    y = "Estimated Suicide Death Rate(per 100,000 population)"
  ) +
  viridis::scale_color_viridis(
    name = "Age Group",
    discrete = TRUE
  )

```
According to the graphs, both the estimated depression prevalence and suicide death rates are the highest among people aged between 45-64, which is also consistent with our results taking the effect of time(years) into account. This suugests the possibility of a existing positive correlation between dpression rate and suicide death rate for people ages from 45 to 64. To justify this finding, we conducted further statistical analysis by constructing linear regression models with age groups as predictors.


