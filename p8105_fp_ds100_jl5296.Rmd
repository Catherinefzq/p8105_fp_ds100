---
title: "Untitled"
author: "Jianyou Liu"
date: "November 30, 2018"
output: github_document
---

```{r setup, include=FALSE}
library(tidyverse)
knitr::opts_chunk$set(echo = TRUE)

knitr::opts_chunk$set(
  fig.width = 6,
  fig.asp = .6,
  out.width = "90%"
)

theme_set(theme_bw() + theme(legend.position = "bottom"))


```

## Age Group VS. Depression Rate
### brfss dataset

#### Load data
```{r read_data, message = FALSE}
brfss_data = read_csv("./data/brfss_data.csv") %>% 
  janitor::clean_names()
View(brfss_data)
```
#### Modify data
```{r modify_data}
new_brfss_data = brfss_data %>% 
  filter(break_out_category_id == "CAT3") %>% 
  select(year, locationabbr, locationdesc, age_group, topic, response, sample_size, data_value, confidence_limit_low, confidence_limit_high) %>% 
  unite(locationabbr, locationdesc, col = "state_city", sep = ",")

age_data = new_brfss_data %>% 
  filter(response == "Yes") %>% 
  mutate(tot_sample_size = ceiling(sample_size/(data_value/100))) %>% 
  mutate(age_group = str_replace(age_group, "25-34", "25-44"), age_group = str_replace(age_group, "35-44", "25-44"), age_group = str_replace(age_group, "45-54", "45-64"),age_group = str_replace(age_group, "55-64", "45-64")，age_group = str_replace(age_group, "18-24", "<25")) %>% 
  select(year, state_city, age_group, sample_size, tot_sample_size, data_value, confidence_limit_low, confidence_limit_high) %>% 
  rename(depress_num = sample_size, depress_rate = data_value) %>% 
  group_by(age_group) %>%
  summarize(total_dep = sum(depress_num, na.rm = TRUE), total_num = sum(tot_sample_size, na.rm = TRUE))
  
```
#### Estimate depression proportion for each age group
```{r prop_test}
# Run prop.test for each age group
test_data = age_data %>% 
  mutate(test_stats = map2(.x = total_dep, .y = total_num, ~ prop.test(x = .x, n = .y, conf.level = .95) %>% broom::tidy())) %>% 
  unnest() %>% 
  select(age_group, total_dep, total_num, estimate, conf.low, conf.high)
```
#### Create plot to show estimated depression rate and CIs for age group
```{r plot}
test_data %>% 
  mutate(age_group = fct_reorder(age_group, estimate)) %>% 
  ggplot(aes(x = age_group, y = estimate, color = age_group)) +
  geom_bar(stat = "identity", position = position_dodge(), width = .6) +
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high), width = .2) +
  labs(
    title = "Estimates of Proportion of Depression and CIs for each Age Category",
    x = "Age Group",
    y = "Estimated Depression Rate"
  ) +
  viridis::scale_color_viridis(
    name = "Age Group",
    discrete = TRUE
  )
  
```

**Comment**: According to the graph, the estimated depression rate is the highest among people aged between 45-64 and the lowest for those above 65.


### Injury Data
#### Load dataset
```{r import_data, message = FALSE}
injury_data = read_csv("./data/NCHS_-_Injury_Mortality__United_States.csv") %>% 
  janitor::clean_names()
```
#### Clean and manipulate data
```{r tidy_data}
new_injury_data = injury_data %>% 
  select(year, age_group_years, injury_intent, deaths, population) %>% 
  distinct(year, age_group_years, injury_intent, .keep_all = TRUE) %>% 
  filter(injury_intent == "Suicide", age_group_years != "All Ages", year %in% c(2011, 2012, 2013, 2014, 2015, 2016)) %>% 
  arrange(year) %>% 
  mutate(age_group_years = str_replace(age_group_years, "15–24","<25"),age_group_years = str_replace(age_group_years, "< 15","<25"
), age_group_years = str_replace(age_group_years, "65–74","65+"), age_group_years = str_replace(age_group_years, "75+","65")) %>% 
  group_by(age_group_years) %>% 
  summarize(tot_suicide_deaths = sum(deaths), tot_pop = sum(population))
  
```
#### Obtain estimated suicide death rate and CIs
```{r prop_test2}
test_data2 = new_injury_data %>% 
  mutate(test_stats = map2(.x = tot_suicide_deaths, .y = tot_pop, ~ prop.test(x = .x, n = .y, conf.level = .95) %>% broom::tidy())) %>% 
  unnest() %>% 
  select(age_group_years, tot_suicide_deaths, tot_pop, estimate, conf.low, conf.high) %>% 
  mutate(estimate = estimate*100000, conf.low = conf.low*100000, conf.high = conf.high*100000)

```
#### Create plot to show estimated suicide death rate for each age group
```{r plot2}
test_data2 %>% 
  mutate(age_group_years = fct_reorder(age_group_years, estimate)) %>% 
  ggplot(aes(x = age_group_years, y = estimate, color = age_group_years)) +
  geom_bar(stat = "identity", position = position_dodge(), width = .6) +
  geom_errorbar(aes(ymin = conf.low , ymax = conf.high), width = .2) +
  labs(
    title = "Estimated suicide death rate(per 100,000 population) and CIs for each Age Category",
    x = "Age Group",
    y = "Estimated Suicide Death Rate(per 100,000 population)"
  ) +
  viridis::scale_color_viridis(
    name = "Age Group",
    discrete = TRUE
  )

```

**Comment**: It appears that people aged between 45 and 64 have both the higest depression rate and also the highest suicide death rate compared with the other age groups.
